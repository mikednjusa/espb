AWSTemplateFormatVersion: 2010-09-09
Parameters:
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Default: INSTANCE_KEY_PAIR
  PublicSubnet:
    Type: AWS::EC2::Subnet::Id
    Default: subnet-b743baed
  PrivateSubnet:
    Type: AWS::EC2::Subnet::Id
    Default: subnet-5847be02
  BenchmarkSG:
    Type: String
    Default: sg-0e1c7070
  ImageId:
    Type: String
    Default: ami-c58c1dd3
  AvailabilityZone:
    Type: String
    Default: REGION
  InstanceType:
    Type: String
    Default: INSTANCE_TYPE
  S3Bucket:
    Type: String
    Default: S3_BUCKET
Resources:
  BenchmarkInstance:
    Type: AWS::EC2::Instance
    Properties:
      KeyName: !Ref KeyName
      SecurityGroupIds:
      - !Ref BenchmarkSG
      UserData:
        Fn::Base64: !Sub |
          yum -y update
          yum -y install python-pip
          pip install -y awscli --upgrade --user
          yum install -y yum-utils device-mapper-persistent-data lvm2
          yum makecache fast
          yum -y install docker-ce
          pip -y install docker-compose
          sysctl -w vm.max_map_count=262144
          systemctl start docker
          yum -y install git
          git clone git clone https://github.com/mikednjusa/espb.git
          docker-compose up
      InstanceType: !Ref InstanceType
      AvailabilityZone: !Ref AvailabilityZone
      ImageId: !Ref ImageId
      SubnetId: !Ref PrivateSubnet
      Tags:
        -
          Key: Name
          Value: Benchmark-ec2
  ESRallyInstance:
    Type: 'AWS::EC2::Instance'
    Properties:
      KeyName: !Ref KeyName
      SecurityGroupIds:
      - !Ref BenchmarkSG
      UserData:
        Fn::Base64: !Sub |
          yum -y update
          yum -y install python-pip
          pip install -y awscli --upgrade --user
          yum install -y yum-utils device-mapper-persistent-data lvm2
          yum makecache fast
          yum -y install docker-ce
          pip -y install docker-compose
          sysctl -w vm.max_map_count=262144
          systemctl start docker
          use/rmod -aG docker ec2-user
          yum -y install git
          yum -y install aws-cli
          git clone https://github.com/mikednjusa/espb.git
          docker-compose up
          python ES_test.py
      InstanceType: !Ref InstanceType
      AvailabilityZone: !Ref AvailabilityZone
      ImageId: !Ref ImageId
      SubnetId: !Ref PublicSubnet
      Tags:
        -
          Key: Name
          Value: EsRally-monitoring

